<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Chat</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 8px; margin-bottom: 10px; }
        .msg { margin-bottom: 4px; }
        .timestamp { color: #888; font-size: 0.8em; margin-left: 6px; }
    </style>
</head>
<body>
<h2>Chat System Test (WebSocket / STOMP)</h2>

<div>
    <label>Username: <input id="username" type="text" placeholder="e.g. bryan"></label>
    <button onclick="connect()">Connect</button>
</div>

<div id="status">Not connected</div>

<div id="messages"></div>

<div>
    <input id="messageInput" type="text" placeholder="Type a message..." style="width: 250px;">
    <button onclick="sendMessage()">Send</button>
</div>

<!-- SockJS + STOMP from CDNs -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;

    function connect() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            alert("Enter a username first.");
            return;
        }

        const socket = new SockJS("/ws"); // backend endpoint from WebSocketConfig
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            document.getElementById("status").innerText = "Connected as " + username;

            // subscribe to the global chat topic
            stompClient.subscribe("/topic/messages", function (messageFrame) {
                const message = JSON.parse(messageFrame.body);
                showMessage(message);
            });
        }, function (error) {
            document.getElementById("status").innerText = "Connection error: " + error;
        });
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            alert("You must connect first.");
            return;
        }

        const username = document.getElementById("username").value.trim();
        const text = document.getElementById("messageInput").value.trim();
        if (!text) return;

        const payload = {
            user: username,
            text: text
            // no timestamp: backend will fill it in
        };

        stompClient.send("/app/message", {}, JSON.stringify(payload));
        document.getElementById("messageInput").value = "";
    }

    function showMessage(msg) {
        const container = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = "msg";

        const time = msg.timestamp ? msg.timestamp : "";
        div.innerHTML = "<strong>" + (msg.user || "unknown") + ":</strong> " +
                        msg.text +
                        (time ? "<span class='timestamp'>" + time + "</span>" : "");

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>
</body>
</html>
