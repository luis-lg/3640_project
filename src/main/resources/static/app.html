<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChatApp â€“ Friends & Chats</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
      }
      header {
        padding: 10px 16px;
        background: #1f2933;
        color: #f9fafb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        margin: 0;
        font-size: 20px;
      }
      header span {
        font-size: 14px;
      }
      header button {
        margin-left: 8px;
      }
      .layout {
        display: grid;
        grid-template-columns: 220px 240px 1fr;
        height: calc(100vh - 48px);
      }
      .panel {
        border-right: 1px solid #ddd;
        padding: 10px;
        box-sizing: border-box;
      }
      .panel h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 16px;
      }
      .list {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
        height: calc(100% - 90px);
        overflow-y: auto;
      }
      .item {
        padding: 4px 6px;
        cursor: pointer;
        border-radius: 4px;
      }
      .item:hover {
        background: #f3f4f6;
      }
      .item.active {
        background: #e5e7eb;
      }
      #friends-status,
      #chats-status {
        font-size: 12px;
        margin-top: 6px;
        min-height: 1.2em;
      }
      /* Right column: messages */
      #messages-panel {
        padding: 10px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      #chat-title {
        margin: 0 0 8px 0;
        font-size: 16px;
      }
      #messages {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px;
        flex: 1;
        overflow-y: auto;
        margin-bottom: 8px;
      }
      .msg {
        margin-bottom: 4px;
      }
      .timestamp {
        color: #999;
        font-size: 0.8em;
        margin-left: 6px;
      }
      #composer {
        display: flex;
        gap: 6px;
      }
      #composer input {
        flex: 1;
        padding: 6px;
      }
      #connection-status {
        font-size: 12px;
        margin-bottom: 4px;
      }
      #no-messages {
        color: #888;
        font-size: 0.9em;
        text-align: center;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ChatApp</h1>
      <div>
        <span id="header-user"></span>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="layout">
      <!-- Left: Friends -->
      <section class="panel">
        <h2>Friends</h2>
        <div>
          <input
            id="add-friend-input"
            type="text"
            placeholder="Friend username"
            style="width: 100%"
          />
          <button style="margin-top: 4px" onclick="addFriend()">Add Friend</button>
        </div>
        <div id="friends-status"></div>
        <div id="friends-list" class="list"></div>
      </section>

      <!-- Middle: Chats (for now mirrors friends + Global) -->
      <section class="panel">
        <h2>Chats</h2>
        <div id="chats-status"></div>
        <div id="chats-list" class="list"></div>
      </section>

      <!-- Right: Messages for selected chat -->
      <section id="messages-panel">
        <div id="connection-status">Not connected</div>
        <h2 id="chat-title">No chat selected</h2>
        <button
          id="clear-chat-btn"
          onclick="clearCurrentChat()"
          style="align-self: flex-start; margin-bottom: 4px"
          disabled
        >
          Clear Chat History
        </button>
        <div id="messages"></div>
        <div id="no-messages">Select a chat to see messages.</div>
        <div id="composer">
          <input
            id="message-input"
            type="text"
            placeholder="Type a message and press Enter"
            onkeydown="if(event.key==='Enter'){sendMessage();}"
          />
          <button onclick="sendMessage()">Send</button>
        </div>
      </section>
    </div>

    <!-- SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let currentUser = null;
      let stompClient = null;

      // Global public chat + per-friend private chats using chatroomId.
      const GLOBAL_CHAT_ID = "public";
      let activeChatId = GLOBAL_CHAT_ID;
      const privateSubscriptions = {}; // chatroomId -> subscription

      function init() {
        const stored = window.localStorage.getItem("chatapp.username");
        if (!stored) {
          // Not logged in: go back to login page
          window.location.href = "/login.html";
          return;
        }
        currentUser = stored;
        document.getElementById("header-user").textContent =
          "Logged in as " + currentUser;

        buildInitialChats();
        loadFriends();
        connectWebSocket();
      }

      function logout() {
        window.localStorage.removeItem("chatapp.username");
        window.location.href = "/login.html";
      }

      // ----- Friends -----

      async function loadFriends() {
        const statusEl = document.getElementById("friends-status");
        const listEl = document.getElementById("friends-list");
        listEl.innerHTML = "";

        try {
          const res = await fetch(
            "/api/friends/list?username=" + encodeURIComponent(currentUser)
          );
          const data = await res.json();
          const friends = data.friends || [];
          statusEl.textContent = "You have " + friends.length + " friend(s).";
          statusEl.style.color = "#555";

          friends.forEach((f) => {
            const div = document.createElement("div");
            div.className = "item";
            div.textContent = f;
            div.onclick = () => openPrivateChatWithFriend(f);
            listEl.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error loading friends.";
          statusEl.style.color = "red";
        }
      }

      async function addFriend() {
        const input = document.getElementById("add-friend-input");
        const friendName = input.value.trim().toLowerCase();
        const statusEl = document.getElementById("friends-status");

        if (!friendName) {
          statusEl.textContent = "Enter a username to add as friend.";
          statusEl.style.color = "red";
          return;
        }
        if (friendName === currentUser) {
          statusEl.textContent = "You cannot add yourself as a friend.";
          statusEl.style.color = "red";
          return;
        }

        try {
          const res = await fetch("/api/friends/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userA: currentUser, userB: friendName }),
          });
          const data = await res.json();
          statusEl.textContent = data.message || "Friend operation complete.";
          statusEl.style.color = data.success ? "green" : "red";
          if (data.success) {
            input.value = "";
            loadFriends();
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error calling /api/friends/add.";
          statusEl.style.color = "red";
        }
      }

      // ----- Chats (for now, just Global) -----

      async function buildInitialChats() {
        const listEl = document.getElementById("chats-list");
        listEl.innerHTML = "";

        const global = document.createElement("div");
        global.className = "item active";
        global.dataset.chatId = GLOBAL_CHAT_ID;
        global.textContent = "Global Chat";
        global.onclick = () => selectChat(GLOBAL_CHAT_ID, global);
        listEl.appendChild(global);

        // Also add a chat entry for each friend (private chatroom)
        try {
          const res = await fetch(
            "/api/friends/list?username=" + encodeURIComponent(currentUser)
          );
          const data = await res.json();
          const friends = data.friends || [];

          friends.forEach(async (friendName) => {
            const chatId = await fetchChatroomId(friendName);
            if (!chatId) return;

            const div = document.createElement("div");
            div.className = "item";
            div.dataset.chatId = chatId;
            div.dataset.friendName = friendName;
            div.textContent = "Chat with " + friendName;
            div.onclick = () => selectChat(chatId, div);
            listEl.appendChild(div);
          });
        } catch (err) {
          console.error("Error building chats from friends:", err);
        }

        document.getElementById("chats-status").textContent =
          "Click a chat to view messages.";
      }

      function selectChat(chatId, el) {
        activeChatId = chatId;
        // highlight selection
        const items = document.querySelectorAll("#chats-list .item");
        items.forEach((i) => i.classList.remove("active"));
        el.classList.add("active");

        const title = getChatTitle(chatId, el);
        document.getElementById("chat-title").textContent = title;
        document.getElementById("clear-chat-btn").disabled = false;

        // Load message history for this chatroom
        loadHistoryForChat(chatId);
      }

      async function openPrivateChatWithFriend(friendName) {
        const chatId = await fetchChatroomId(friendName);
        if (!chatId) return;

        const listEl = document.getElementById("chats-list");
        let item = Array.from(listEl.querySelectorAll(".item")).find(
          (el) => el.dataset.chatId === chatId
        );

        if (!item) {
          item = document.createElement("div");
          item.className = "item";
          item.dataset.chatId = chatId;
          item.dataset.friendName = friendName;
          item.textContent = "Chat with " + friendName;
          item.onclick = () => selectChat(chatId, item);
          listEl.appendChild(item);
        }

        selectChat(chatId, item);
      }

      function getChatTitle(chatId, el) {
        if (chatId === GLOBAL_CHAT_ID) {
          return "Global Chat";
        }
        const friendName = el && el.dataset ? el.dataset.friendName : null;
        if (friendName) {
          return "Chat with " + friendName;
        }
        return "Chat " + chatId;
      }

      async function fetchChatroomId(friendName) {
        try {
          const res = await fetch(
            "/api/friends/chatroom-id?userA=" +
              encodeURIComponent(currentUser) +
              "&userB=" +
              encodeURIComponent(friendName)
          );
          const data = await res.json();
          return data.chatroomId;
        } catch (err) {
          console.error("Error fetching chatroomId:", err);
          return null;
        }
      }

      async function loadHistoryForChat(chatId) {
        const container = document.getElementById("messages");
        container.innerHTML = "";
        const placeholder = document.getElementById("no-messages");
        placeholder.textContent = "Loading messages...";
        try {
          const res = await fetch(
            "/api/messages/history?chatroomId=" +
              encodeURIComponent(chatId) +
              "&limit=50"
          );
          const data = await res.json();
          const messages = data.messages || [];
          if (messages.length === 0) {
            placeholder.textContent = "No messages yet. Say hi!";
          } else {
            placeholder.textContent = "";
            messages.forEach((m) => showMessage(m, chatId));
          }
        } catch (err) {
          console.error("Error loading history:", err);
          document.getElementById("no-messages").textContent =
            "Error loading messages.";
        }
      }

      // ----- WebSocket public chat (reusing existing backend) -----

      function connectWebSocket() {
        const statusEl = document.getElementById("connection-status");

        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            statusEl.textContent = "Connected as " + currentUser;

            // subscribe to global topic
            stompClient.subscribe("/topic/messages", function (messageFrame) {
              const message = JSON.parse(messageFrame.body);
              showMessage(message, GLOBAL_CHAT_ID);
            });

            // subscribe to users list (optional)
            stompClient.subscribe("/topic/users", function (frame) {
              const onlineUsers = JSON.parse(frame.body);
              console.log("ONLINE USERS:", onlineUsers);
            });

            // notify join
            stompClient.send(
              "/app/connect",
              {},
              JSON.stringify({ username: currentUser })
            );
          },
          function (error) {
            statusEl.textContent = "Connection error: " + error;
          }
        );
      }

      function sendMessage() {
        if (!stompClient || !stompClient.connected) {
          alert("You must be connected first.");
          return;
        }
        if (!currentUser) {
          alert("You must be logged in.");
          return;
        }

        const input = document.getElementById("message-input");
        const text = input.value.trim();
        if (!text) return;

        const payload = {
          user: currentUser,
          text: text,
          chatroomId: activeChatId,
        };

        if (activeChatId === GLOBAL_CHAT_ID) {
          stompClient.send("/app/message", {}, JSON.stringify(payload));
        } else {
          // private chatroom
          ensureSubscribedToPrivate(activeChatId);
          stompClient.send(
            "/app/private/" + activeChatId,
            {},
            JSON.stringify(payload)
          );
        }
        input.value = "";
      }

      function ensureSubscribedToPrivate(chatId) {
        if (!stompClient || !stompClient.connected) return;
        if (privateSubscriptions[chatId]) return;

        const sub = stompClient.subscribe(
          "/topic/private/" + chatId,
          function (frame) {
            const message = JSON.parse(frame.body);
            showMessage(message, chatId);
          }
        );
        privateSubscriptions[chatId] = sub;
      }

      function showMessage(msg, chatIdHint) {
        // Only show messages for the active chat
        const chatId = msg.chatroomId || chatIdHint || GLOBAL_CHAT_ID;
        if (chatId !== activeChatId && chatId !== GLOBAL_CHAT_ID) {
          return;
        }

        const container = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = "msg";

        const time = msg.timestamp ? msg.timestamp : "";
        div.innerHTML =
          "<strong>" +
          (msg.user || "unknown") +
          ":</strong> " +
          msg.text +
          (time ? "<span class='timestamp'>" + time + "</span>" : "");

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        document.getElementById("no-messages").textContent = "";
      }

      async function clearCurrentChat() {
        if (!activeChatId || activeChatId === "") return;
        const ok = confirm(
          "Clear history for this chat? This deletes stored messages on the server."
        );
        if (!ok) return;

        try {
          await fetch(
            "/api/messages/history?chatroomId=" +
              encodeURIComponent(activeChatId),
            { method: "DELETE" }
          );
          // Clear messages in UI
          document.getElementById("messages").innerHTML = "";
          document.getElementById("no-messages").textContent =
            "No messages yet. Say hi!";
        } catch (err) {
          console.error("Error clearing history:", err);
        }
      }

      window.addEventListener("beforeunload", function () {
        if (stompClient && stompClient.connected && currentUser) {
          stompClient.send(
            "/app/disconnect",
            {},
            JSON.stringify({ username: currentUser })
          );
        }
      });

      window.addEventListener("load", init);
    </script>
  </body>
</html>


