<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChatApp â€“ Login + Chat</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      h2 {
        margin-bottom: 8px;
      }
      fieldset {
        margin-bottom: 16px;
      }
      #messages {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        padding: 8px;
        margin-bottom: 10px;
      }
      .msg {
        margin-bottom: 4px;
      }
      .timestamp {
        color: #888;
        font-size: 0.8em;
        margin-left: 6px;
      }
      #chat-area {
        display: none;
      } /* hidden until logged in and connected */
      #status {
        margin-top: 6px;
        font-weight: bold;
      }
      #login-status {
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <h2>Chat System (Login + WebSocket Chat)</h2>

    <fieldset>
      <legend>Account</legend>
      <label>
        Username:
        <input id="login-username" type="text" placeholder="e.g. alice" />
      </label>
      <br />
      <label>
        Password:
        <input
          id="login-password"
          type="password"
          placeholder="your password"
        />
      </label>
      <br />
      <button onclick="registerUser()">Register</button>
      <button onclick="loginUser()">Login</button>
      <div id="login-status"></div>
    </fieldset>

    <fieldset id="chat-area">
      <legend>Chat</legend>

      <div id="status">Not connected</div>

      <div id="messages"></div>

      <div>
        <input
          id="messageInput"
          type="text"
          placeholder="Type a message..."
          style="width: 250px"
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </fieldset>

    <!-- SockJS + STOMP from CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let stompClient = null;
      let loggedInUser = null;

      async function registerUser() {
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value.trim();
        const statusEl = document.getElementById("login-status");

        if (!username || !password) {
          statusEl.innerText = "Please enter username and password.";
          statusEl.style.color = "red";
          return;
        }

        try {
          const response = await fetch("/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();
          statusEl.innerText = data.message || "Registration response received";
          statusEl.style.color = data.success ? "green" : "red";
        } catch (err) {
          statusEl.innerText = "Error calling /api/auth/register";
          statusEl.style.color = "red";
          console.error(err);
        }
      }

      async function loginUser() {
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value.trim();
        const statusEl = document.getElementById("login-status");

        if (!username || !password) {
          statusEl.innerText = "Please enter username and password.";
          statusEl.style.color = "red";
          return;
        }

        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (data.success) {
            loggedInUser = username;
            statusEl.innerText = "Login successful as " + username;
            statusEl.style.color = "green";
            // show chat UI and connect to WebSocket
            document.getElementById("chat-area").style.display = "block";
            connectWebSocket();
          } else {
            loggedInUser = null;
            statusEl.innerText = data.message || "Login failed";
            statusEl.style.color = "red";
          }
        } catch (err) {
          loggedInUser = null;
          statusEl.innerText = "Error calling /api/auth/login";
          statusEl.style.color = "red";
          console.error(err);
        }
      }

      function connectWebSocket() {
        if (!loggedInUser) {
          alert("You must log in first.");
          return;
        }

        const socket = new SockJS("/ws"); // same backend endpoint
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            document.getElementById("status").innerText =
              "Connected as " + loggedInUser;

            // subscribe to the global chat topic
            stompClient.subscribe("/topic/messages", function (messageFrame) {
              const message = JSON.parse(messageFrame.body);
              showMessage(message);
            });

            // subscribe to users list (optional)
            stompClient.subscribe("/topic/users", function (frame) {
              const onlineUsers = JSON.parse(frame.body);
              console.log("ONLINE USERS:", onlineUsers);
            });

            // publish user joined to /app/connect
            stompClient.send(
              "/app/connect",
              {},
              JSON.stringify({ username: loggedInUser })
            );
          },
          function (error) {
            document.getElementById("status").innerText =
              "Connection error: " + error;
          }
        );
      }

      function sendMessage() {
        if (!stompClient || !stompClient.connected) {
          alert("You must be connected first.");
          return;
        }
        if (!loggedInUser) {
          alert("You must log in first.");
          return;
        }

        const text = document.getElementById("messageInput").value.trim();
        if (!text) return;

        const payload = {
          user: loggedInUser,
          text: text,
          // no timestamp: backend will fill it in
        };

        stompClient.send("/app/message", {}, JSON.stringify(payload));
        document.getElementById("messageInput").value = "";
      }

      function showMessage(msg) {
        const container = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = "msg";

        const time = msg.timestamp ? msg.timestamp : "";
        div.innerHTML =
          "<strong>" +
          (msg.user || "unknown") +
          ":</strong> " +
          msg.text +
          (time ? "<span class='timestamp'>" + time + "</span>" : "");

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      // send /disconnect automatically when closing the tab
      window.addEventListener("beforeunload", function () {
        if (stompClient && stompClient.connected && loggedInUser) {
          stompClient.send(
            "/app/disconnect",
            {},
            JSON.stringify({ username: loggedInUser })
          );
        }
      });
    </script>
  </body>
</html>
